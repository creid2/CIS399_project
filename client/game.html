<html>
  <head>
    <title>Game</title>
    <link href="stylesheets/style.css" rel="stylesheet" type="text/css">
    <link href="stylesheets/gamestyle.css" rel="stylesheet" type="text/css">
  </head>
  <body>
    <!-- on hover, show a menu of options -->
    <div id='titleBar'></div>

    <!-- div socketNum added for testing -matti-->
    <div id='socketNum'></div>            

    <div id='container'>

      <div id='panel'>
        <h3>Question:</h3> 

        <!-- need random question generator -->
        <p id='question'>What is the capital of Oregon?<br> </p>
        <br><br>
        <!-- need decrementer timer -->
        <p id='timer'><b>Time left: </b><span id='time'> </span></p>

        <!-- User clickable button to claim a bingo -->
        <p><button id='bingo' onclick='checkVictory();'>Bingo!</button></p>

        <!-- need js function to show and hide depending on user -->
        <div id='teacherOptions'>
          <h3>Extras in teacher view:</h3>
          <button>Abort the game</button><br>
          <button id='startTimer'>Start</button><br>
        </div> 

      </div>
      <div id='leaderDiv'>
        <table id='leaderBoard' >
          <tr class='lbRow-id' >
            <td class='player1'>PLAYER 1</td>          
            <td class='player2'>PLAYER 2</td>          
            <td class='player3'>PLAYER 3</td>           
            <td class='player4'>PLAYER 4</td> 
            <td class='player5'>PLAYER 5</td>         
          </tr>
          <tr class='lbRow-1' >
            <td class='lbCell-1'></td>          
            <td class='lbCell-2'></td>          
            <td class='lbCell-3'></td>           
            <td class='lbCell-4'></td> 
            <td class='lbCell-5'></td>         
          </tr>
          <tr class='lbRow-2' >
            <td class='wins1'>0</td>          
            <td class='wins2'>0</td>          
            <td class='wins3'>0</td>           
            <td class='wins4'>0</td> 
            <td class='wins5'>0</td>         
          </tr>
        </table>

      </div>
      <div id='board'>
        <table>
          <tr class='row-0'>
            <td class='cell-0'></td>          
            <td class='cell-1'></td>          
            <td class='cell-2'></td>           
            <td class='cell-3'></td>          
            <td class='cell-4'></td>
          </tr>
          <tr class='row-1'>
            <td class='cell-0'></td>
            <td class='cell-1'></td>
            <td class='cell-2'></td>
            <td class='cell-3'></td>
            <td class='cell-4'></td>
          </tr>
          <tr class='row-2'>
            <td class='cell-0'></td>
            <td class='cell-1'></td>
            <td class='cell-2'></td>
            <td class='cell-3'></td>
            <td class='cell-4'></td>
          </tr>
          <tr class='row-3'>
            <td class='cell-0'></td>
            <td class='cell-1'></td>
            <td class='cell-2'></td>
            <td class='cell-3'></td>
            <td class='cell-4'></td>
          </tr>
          <tr class='row-4'>
            <td class='cell-0'></td>
            <td class='cell-1'></td>
            <td class='cell-2'></td>
            <td class='cell-3'></td>
            <td class='cell-4'></td>
          </tr>
        </table>
      </div>
    </div>

    <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>

     <script>
       var prevClicked = [ ];
       var clicked = false;
       var prevAnswer;
       var socket = io();
       var idNum=0;
       var numCorrect=0;
       var numTotalWins=0;

       var boardArray = [ ];
       // Initialize to all false
       for (var i = 0; i < 5; i++) {
        boardArray[i] = [false, false, false, false, false];
       }

    function readCookie() {
      console.log('reading cookie');
      var name = "username" + "=";
      var ca = document.cookie.split(';');
      console.log(ca);
      for(var i=0; i<ca.length; i++) {
        var c = ca[i];
      };  
        
      $('#titleBar').text(c.split('=')[1]);
        
      // while (c.charAt(0)==' ') c = c.substring(1);
      // if (c.indexOf(name) == 0) {
      //   console.log( c.substring(name.length,c.length));
      // }
    };

     
    socket.on('id', function(id){

        if(!$('#titleBar').text()){
          readCookie();
        };
        

       // When the server sends a randomized list of questions and answers, put
       // them into the gameboard:
       socket.on('randomBoard', function(msg) {
           // After receiving the data from the server, put it into the gameboard
           for (var i = 0; i < 5; i++) {
               for (var j = 0; j < 5; j++) {
                   $('.row-' + i + ' > .cell-' + j).css("background-color", "white");
                   $('.row-' + i + ' > .cell-' + j).text(msg[i*5 + j].answer);
               }
           }
       });

	   });


    socket.emit('inGame',idNum);

    socket.on('inGame',function(msg){
        if (idNum==0){ 
          idNum = msg;
        };
        if(!$('#socketNum').text()){
          $('#socketNum').text(idNum);
        };
        $('.player'+idNum) .text($('#titleBar').text());
    });

      socket.on('userWon', function(msg) {
        receivedVictory(msg);
      });

      socket.on('newQuestion', function(msg) {
        clicked = false;

        // Evaulate old question
        if (prevClicked.length > 0) {
          var temp = $('.row-' + prevClicked[0] + ' > .cell-' + prevClicked[1]);

          // Are we correct?
          if (temp.text() === prevAnswer) {
            // Update background color
            temp.css("background-color", "green");
            // Update internal array of correct answers
            boardArray[prevClicked[0]][prevClicked[1]] = true;

            // Update the number of correct answers, and let the server know
            numCorrect+=1;
            socket.emit('idUpdate', idNum +':'+numCorrect + ':'+ $('#titleBar').text());
          } else {
            temp.css("background-color", "white");
          }
        }
        // Reset prevClicked
        prevClicked = [ ];

        // Receive the new question from the server
        prevAnswer = msg.answer;
        $('#question').text(msg.question);
      });

      socket.on('idUpdate' , function(msg){
        console.log("leaderbord update");
        var id = msg.split(':')[0];
        var correct= msg.split(':')[1];
        var username = msg.split(':')[2];
        console.log('ID #: '+id);
        var temp=$('.lbCell-'+id);
        temp.text(correct);
        var temp=$('.player'+id);
        console.log(username , temp);
        temp.text(username);
      });

      $('td').click(function(){                
        var el = $(this);
        var cellNum = el.attr('class').split('-')[1];
        var rowNum = el.parent().attr('class').split('-')[1];

        if (!clicked && !boardArray[rowNum][cellNum]) {
          clicked = true;

          // Highlight the clicked box
          $('.row-' + rowNum + ' > .cell-' + cellNum).css("background-color", "yellow");

          // Update the global variable
          prevClicked = [rowNum, cellNum];
          //onClick(rowNum, cellNum);

          // Debugging
          console.log(prevClicked);
        }
      });

      function checkVictory() {
        /* Checks if there is a row of 5, and if so, sends that information to
        * the server.
        * 
        * Questions:
        *   1.  If a user claims to have a bingo, but doesn't have one, 
        *       should they be penalized?
        *   2.  If a user doesn't notice that they have a bingo, should they
        *       win on end of question anyway?
        */

        // The existing global variable 'boardArray' is a 5x5 array of booleans
        // representing correct answers. It will not have the most recent click
        // represented, so have to check that now.
        var temp = $('.row-' + prevClicked[0] + ' > .cell-' + prevClicked[1]);
        if (temp.text() === prevAnswer) {
          boardArray[prevClicked[0]][prevClicked[1]] = true;
        }

        var countRow = 0; 
        var countCol = 0; 
        // Check all rows and columns:
        if($('#titleBar').text() == 'matti')
             sendVictory();                                   //my hack
        for (var i = 0; i < 5; i++) {
          for (var j = 0; j < 5; j++) {
            if (boardArray[i][j] === true) 
              countCol++;
            if (boardArray[j][i] === true)
              countRow++;
          }
          // Victory condition:
          
          if (countCol === 5 || countRow === 5)
            sendVictory();

          // Reset the count before checking the next column
          countRow = 0;
          countCol = 0;
        }

        // Check the diagonals:
        var countDiag1 = 0;
        var countDiag2 = 0;
        for (var i = 0; i < 5; i++) {
          if (boardArray[i][i] === true)
            countDiag1++;
          if (boardArray[4-i][i] === true)
            countDiag2++;
        }
        if (countDiag1 === 5 || countDiag2 === 5)
          sendVictory();
      }

      function sendVictory() {          
        /* Sends a message to the server indicating that you have won the game
         * Called by checkVictory()
         * If we decide that points carry over between rounds, we could give
         * the winner some number of extra points here.
         */
        console.log("sendVictory called.");
        numTotalWins += 1;
        socket.emit('claimVictory', idNum +':'+numCorrect + ':'+ $('#titleBar').text()+ ':'+ numTotalWins);       //matti


      }

      function receivedVictory(msg) {
        /* When someone wins and lets the server know, the server will broadcast
         * that information to everyone, calling this function. For now, just an
         * alert box. 
         */

        if (msg.split(':')[2] == $('#titleBar').text()){
            window.alert('YOU WON !!!!');
            numTotalWins +=1;
            console.log("my total wins: " + numTotalWins);
            
        }else{
        window.alert(msg.split(':')[2] + " won the game, with "+ msg.split(':')[1]+" points!");
        };
        var id = msg.split(':')[0];
        var temp=$('.wins'+id);
        console.log("numwins: "+msg.split(':')[3]);
        temp.text(msg.split(':')[3]);
        numCorrect = 0;
        
        var resetInfo = { }; // in case we want to emit information here
        socket.emit('reset', resetInfo);
      }

      // Would like to have a method to auto-disconnect on tab/window closing,
      // but can't figure it out. Chrome makes it a privacy feature, I think.

    </script>
  </body>
</html>
